##################################
# Docker image deployment pipeline
##################################
steps:
  - label: Get docker tag and save it as metadata for use later
    command: .buildkite/scripts/set_docker_tag_meta_data.sh

  - wait

  - label: Update staging docker image tags (master branches only)
    branches: master
    command:
      - .buildkite/scripts/build_tag_push_deployment_image.sh
      - .buildkite/scripts/promote_deployment_image_to.sh staging
    agents:
      buildkite_agent_size: large

  - label: Update staging beta docker image tags (beta branch only)
    branches: beta
    command:
      - .buildkite/scripts/build_tag_push_deployment_image.sh
      - .buildkite/scripts/promote_deployment_image_to.sh staging-beta
    agents:
      buildkite_agent_size: large

  - label: Update hardware staging docker image tags (master branches only)
    branches: master
    command:
      - .buildkite/scripts/build_tag_push_deployment_image.sh
      - .buildkite/scripts/promote_deployment_image_to.sh staging-hw
    env:
      SGX_MODE: HW
      DEPLOYMENT_VARIANT: hw
    agents:
      buildkite_agent_size: large

  - wait

  - label: "Trigger staging deployment (master branches only)"
    trigger: private-ops-deploy-ekiden-staging
    branches: master
    build:
      message: "${BUILDKITE_MESSAGE}"
      commit: HEAD
      branch: master

  - label: "Trigger staging beta deployment (beta branch only)"
    trigger: private-ops-deploy-ekiden-staging-beta
    branches: beta
    build:
      message: "${BUILDKITE_MESSAGE}"
      commit: HEAD
      branch: master

  - label: "Trigger hardware staging deployment (master branches only)"
    trigger: private-ops-deploy-ekiden-hardware-staging
    branches: master
    build:
      message: "${BUILDKITE_MESSAGE}"
      commit: HEAD
      branch: master
