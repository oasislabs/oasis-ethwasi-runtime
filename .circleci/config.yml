version: 2
jobs:
  build:
    docker:
      - image: ekiden/testing:0.2.0
    resource_class: xlarge
    steps:
      # Set up
      - run: echo 'PS1='"'"'\$ '"'"'; . /root/.bashrc' >> $BASH_ENV
      - run: echo 'export SGX_MODE=SIM' >> $BASH_ENV
      - run: echo 'export INTEL_SGX_SDK=/opt/sgxsdk' >> $BASH_ENV
      - run: echo 'export EKIDEN_UNSAFE_SKIP_AVR_VERIFY=1' >> $BASH_ENV
      - checkout

      # Install Ekiden binaries.
      - run:
          environment:
            CARGO_TARGET_DIR: target
          command: >-
            cargo install
            --git https://github.com/oasislabs/ekiden
            --branch master
            --debug
            ekiden-tools
      - run:
          environment:
            CARGO_TARGET_DIR: target
          command: >-
            cargo install
            --git https://github.com/oasislabs/ekiden
            --branch master
            --debug
            ekiden-compute
      - run:
          environment:
            CARGO_TARGET_DIR: target
          command: >-
            cargo install
            --git https://github.com/oasislabs/ekiden
            --branch master
            --debug
            ekiden-node-dummy
      # Build the runtime.
      - run: cargo ekiden build-enclave --output-identity
      # Build the benchmarking version of the runtime (in release mode)
      - run: mkdir target_benchmark
      - run:
          name: Build the benchmarking version of the runtime
          environment:
            CARGO_TARGET_DIR: target_benchmark
          command: cargo ekiden build-enclave --output-identity --cargo-addendum feature.benchmark.addendum --target-dir target_benchmark --release -- --features "benchmark"
      # Run the runtime tests.
      - run:
          name: Run the runtime tests
          command: cargo test
      # Build the web3 gateway.
      - run:
          name: Build the web3 gateway
          environment:
            CARGO_TARGET_DIR: ../target
          working_directory: gateway
          command: cargo build
      # Run the gateway tests.
      - run:
          name: Run the gateway tests
          environment:
            CARGO_TARGET_DIR: ../target
          working_directory: gateway
          command: cargo test
      # Build the web3 microbenchmark.
      - run:
          name: Build the web3 microbenchmark
          environment:
            CARGO_TARGET_DIR: ../target
          working_directory: benchmark
          command: cargo build
      # Build the genesis state injector program.
      - run:
          name: Build the genesis state injector tool
          environment:
            CARGO_TARGET_DIR: ../target
          working_directory: genesis
          command: cargo build
      # Build the playback program.
      - run:
          name: Build the transaction playback tool
          environment:
            CARGO_TARGET_DIR: ../target
          working_directory: playback
          command: cargo build
      # Check style. This needs to be after everything is built.
      - run: cargo fmt -- --write-mode=check

      # End-to-end tests.
      - run: ./scripts/test-e2e.sh

  set-docker-tag:
    docker:
      - image: circleci/python:3.6.6-jessie
    steps:
      # Setup version tracking environment variables
      - checkout
      - run: 
          name: Load docker tag versioning into environment
          command: ./scripts/determine-build-versioning.sh /tmp/build_image_tag

      # Save docker tag
      - persist_to_workspace:
          root: /tmp
          paths: 
            - build_image_tag

  build-and-publish-docker-image:
    docker:
      - image: ekiden/testing:0.2.0
    resource_class: xlarge
    steps:
      # Set up
      - run: echo 'PS1='"'"'\$ '"'"'; . /root/.bashrc' >> $BASH_ENV
      - run: echo 'export SGX_MODE=SIM' >> $BASH_ENV
      - run: echo 'export INTEL_SGX_SDK=/opt/sgxsdk' >> $BASH_ENV
      - run: echo 'export EKIDEN_UNSAFE_SKIP_AVR_VERIFY=1' >> $BASH_ENV
      - checkout
      - setup_remote_docker
    
      - attach_workspace:
          at: /workspace

      - run: 
          name: Load current docker tag
          command: echo 'BUILD_IMAGE_TAG=`cat /workspace/build_image_tag`' >> $BASH_ENV

      # Build deployment image.
      - run: |
          echo "$DOCKERHUB_PASSWORD" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
          BUILD_IMAGES_NO_ENTER=1 ./docker/deployment/build-images.sh

      # Push deployment image.
      - run: docker push oasislabs/ekiden-runtime-ethereum:$BUILD_IMAGE_TAG
  
  deploy-to-staging:
    docker:
      - image: circleci/python:3.6.6-jessie
    steps:
      - attach_workspace:
          at: /workspace

      - run: 
          name: Load current docker tag
          command: echo 'BUILD_IMAGE_TAG=`cat /workspace/build_image_tag`' >> $BASH_ENV

      - run:
          name: Trigger a webhook on ops-production for a staging deploy
          # This doesn't exist yet...
          command: curl -d '{"type":"staging","repository":"oasislabs/ekiden","tag":"'${BUILD_IMAGE_TAG}'"}' -H "Content-Type: application/json" -X POST https://buildhook.ops-production.oasiscloud.io/webhook?token=sometoken

  promote-to-production:
    docker:
      - image: circleci/python:3.6.6-jessie
    steps:
      - attach_workspace:
          at: /workspace

      - run: 
          name: Load current docker tag
          command: echo 'BUILD_IMAGE_TAG=`cat /workspace/build_image_tag`' >> $BASH_ENV

      # Login to docker
      - run: |
          echo "$DOCKERHUB_PASSWORD" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
      
      - run:
          name: Download the tag of ekiden for this current workflow
          command: docker pull oasislabs/ekiden-runtime-ethereum:$BUILD_IMAGE_TAG

      - run:
          name: Tag the ekiden build on this workflow for production
          command: docker tag oasislabs/ekiden-runtime-ethereum:$BUILD_IMAGE_TAG oasislabs/testnet:$PRODUCTION_TAG

      - run:
          name: Push the new production tag of ekiden to dockerhub
          command: docker push oasislabs/ekiden-runtime-ethereum:$PRODUCTION_TAG

  deploy-to-production:
    docker:
      - image: circleci/python:3.6.6-jessie
    steps:
      - attach_workspace:
          at: /workspace

      - run: 
          name: Load current docker tag
          command: echo 'BUILD_IMAGE_TAG=`cat /workspace/build_image_tag`' >> $BASH_ENV

      - run:
          name: Trigger a webhook on ops-production for a staging deploy
          # This doesn't exist yet...
          command: curl -d '{"type":"production","repository":"oasislabs/ekiden","tag":"'${BUILD_IMAGE_TAG}'"}' -H "Content-Type: application/json" -X POST https://buildhook.ops-production.oasiscloud.io/webhook?token=sometoken

workflows:
  version: 2
  build:
    jobs:
      - build
      - set-docker-tag
      - build-and-publish-docker-image:
          requires:
            - set-docker-tag
      - deploy-to-staging:
          filters:
            branches:
              only: master
          requires:
            - build-and-publish-docker-image
      - hold-for-production:
          requires:
            - deploy-to-staging
      - promote-to-production:
          requires:
            - hold-for-production
      - deploy-to-production:
          requires:
            - promote-to-production

experimental:
  notify:
    branches:
      only:
        - master
